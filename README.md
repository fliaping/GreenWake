# GreenWake

æœ¬é¡¹ç›®ä¸ºè¿œç¨‹å”¤é†’çš„å®Œæ•´æ–¹æ¡ˆï¼ŒåŒ…å« Greenwake Bridge æœåŠ¡ç«¯å’Œ Greenwake Guard å®¢æˆ·ç«¯

1. Greenwake Bridgeï¼š è¿œç¨‹å”¤é†’ä¸ç«¯å£è½¬å‘å·¥å…·ï¼Œå®ç°æŒç»­å”¤é†’å’Œè¯·æ±‚å”¤é†’
   1. æ‰“å¼€ç½‘é¡µå®ç°æŒç»­å”¤é†’
   2. é€šè¿‡ç«¯å£è½¬å‘å®ç°è¯·æ±‚æ—¶å”¤é†’ï¼Œç±»ä¼¼å‡½æ•°æœåŠ¡ï¼Œå®ç°è¯·æ±‚æ—¶å”¤é†’ï¼Œç©ºé—²ä¼‘çœ ï¼ˆéœ€é…åˆ Greenwake Guard å®¢æˆ·ç«¯ï¼Œå¦åˆ™å¯èƒ½å‡ºç°æœåŠ¡ä¸­é¢„æœŸå¤–ä¼‘çœ ï¼‰
2. Greenwake Guardï¼š ç³»ç»Ÿä¼‘çœ æ§åˆ¶å·¥å…·ï¼Œå®ç°ç³»ç»Ÿä¼‘çœ æ§åˆ¶ï¼Œæ”¯æŒæ°¸ä¹…å”¤é†’ã€å®šæ—¶å”¤é†’ã€å¤–éƒ¨äº‹ä»¶å”¤é†’

![Greenwake-Bridge](./images/greenwake-bridge-web.png)

![Greenwake-Guard](./images/greenwake-guard-macos.png)

## Greenwake Bridge

ä¸€ä¸ªåŸºäº Web çš„è¿œç¨‹ PC å”¤é†’å’Œç«¯å£è½¬å‘ç®¡ç†å·¥å…·ï¼Œæ”¯æŒå¤šä¸»æœºç®¡ç†ã€è‡ªåŠ¨å”¤é†’å’Œç«¯å£è½¬å‘ï¼Œ å°¤å…¶æ˜¯è½¬å‘å‰å”¤é†’çš„åŠŸèƒ½ï¼Œå¯ä»¥æ— ç—›ä½¿ç”¨ä¼‘çœ ä¸»æœºçš„æœåŠ¡ï¼Œ ä¾‹å¦‚é€šè¿‡ä¸€æ¡sshå‘½ä»¤å°±èƒ½å°†è¿œç¨‹ä¸»æœºå”¤é†’å¹¶è¿æ¥ã€‚

### åŠŸèƒ½ç‰¹ç‚¹

- ğŸ–¥ï¸ å¤šä¸»æœºç®¡ç†ï¼šæ”¯æŒç®¡ç†å¤šå°è¿œç¨‹ä¸»æœº
- ğŸ”„ è‡ªåŠ¨å”¤é†’ï¼šé€šè¿‡ WOL (Wake-on-LAN) å®ç°è¿œç¨‹å”¤é†’
- ğŸš€ ç«¯å£è½¬å‘ï¼šæ”¯æŒå¤šç«¯å£è½¬å‘é…ç½®ï¼Œè½¬å‘æ—¶å”¤é†’
- ğŸ”„ è‡ªåŠ¨é‡è¯•ï¼šä¸»æœºå”¤é†’å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•
- ğŸ“Š å®æ—¶ç›‘æ§ï¼šæ˜¾ç¤ºä¸»æœºçŠ¶æ€ã€å®¢æˆ·ç«¯è¿æ¥ä¿¡æ¯
- ğŸŒ Web ç•Œé¢ï¼šå‹å¥½çš„ Web ç®¡ç†ç•Œé¢

### é…ç½®æ–‡ä»¶è¯´æ˜

```yaml
log:
  level: "debug"  # æ—¥å¿—çº§åˆ«ï¼šdebug, info, warn, errorï¼ˆé»˜è®¤ï¼šdebugï¼‰

http:
  port: "8055"    # WebæœåŠ¡ç«¯å£ï¼ˆé»˜è®¤ï¼š8055ï¼‰
  user: "admin"   # ç®¡ç†å‘˜ç”¨æˆ·å
  password: "123456" # ç®¡ç†å‘˜å¯†ç 
  refresh_interval: 30  # çŠ¶æ€åˆ·æ–°é—´éš”ï¼Œå•ä½ç§’ï¼ˆé»˜è®¤ï¼š30ï¼‰

hosts:  # ä¸»æœºé…ç½®
  - name: "home-pc"        # ä¸»æœºåç§°
    ip: "192.168.1.100"    # ä¸»æœºIP
    mac: "XX:XX:XX:XX:XX:XX" # ä¸»æœºMACåœ°å€
    monitor_port: 3389     # ç›‘æ§ç«¯å£
    wake_timeout: 5        # å”¤é†’è¶…æ—¶æ—¶é—´(ç§’)ï¼Œé»˜è®¤10ç§’
    retry_count: 4         # å”¤é†’é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤1æ¬¡
    wake_interval: 5       # å”¤é†’é—´éš”æ—¶é—´(ç§’)ï¼Œé»˜è®¤5ç§’

forwards:  # ç«¯å£è½¬å‘é…ç½®
  - service_port: 13322    # æœåŠ¡ç«¯ç›‘å¬ç«¯å£
    target_host: "home-pc" # ç›®æ ‡ä¸»æœºåç§°
    target_port: 22022     # ç›®æ ‡ä¸»æœºç«¯å£
```

### ä½¿ç”¨æŒ‡å—

#### Docker æ–¹å¼å¯åŠ¨

1. å‡†å¤‡é…ç½®æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰

```bash
# å¦‚æœéœ€è¦è‡ªå®šä¹‰é…ç½®ï¼Œå¯ä»¥åˆ›å»ºé…ç½®æ–‡ä»¶
vim ./config.yaml  # ç¼–è¾‘é…ç½®æ–‡ä»¶
```

2. è¿è¡Œå®¹å™¨

```bash
docker run -d \
  --name greenwake-bridge \
  --restart unless-stopped \
  -p 8055:8055 \
  -v ./config.yaml:/app/config.yaml \
  xuping/greenwake-bridge:latest
```

å¦‚æœæ²¡æœ‰æä¾›é…ç½®æ–‡ä»¶ï¼Œç¨‹åºä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªé»˜è®¤é…ç½®ã€‚é»˜è®¤é…ç½®åŒ…æ‹¬ï¼š

- æ—¥å¿—çº§åˆ«ï¼šdebug
- HTTP ç«¯å£ï¼š8055
- çŠ¶æ€åˆ·æ–°é—´éš”ï¼š30ç§’
- å”¤é†’è¶…æ—¶æ—¶é—´ï¼š10ç§’
- å”¤é†’é‡è¯•æ¬¡æ•°ï¼š1æ¬¡
- å”¤é†’é—´éš”æ—¶é—´ï¼š5ç§’

#### æœ¬åœ°ç¼–è¯‘å¯åŠ¨

1. å…‹éš†ä»£ç 

```bash
git clone https://github.com/fliaping/GreenWake.git
cd greenwake-bridge
```

2. ç¼–è¯‘è¿è¡Œ

```bash
# ç¼–è¯‘å‰ç«¯
cd web
npm install
npm run build

# ç¼–è¯‘åç«¯
cd ..
# [MacOs]å®‰è£…task
brew install go-task/tap/go-task
# [å¹³å°é€šç”¨]å®‰è£…task
go install github.com/go-task/task/v3/cmd/task@latest

# å®‰è£…ä¾èµ–
task install-deps
#[å¯é€‰]æ•´ç†å’Œæ¸…ç†é¡¹ç›®ä¾èµ–å…³ç³»
go mod tidy 

# ç›´æ¥è¿è¡Œ
go run cmd/server/main.go  # é…ç½®æ–‡ä»¶ä¼šè‡ªåŠ¨åˆ›å»º

# æˆ–è€…æ„å»º&è¿è¡Œ
go build -o greenwake-bridge ./cmd/server
./greenwake-bridge  # é…ç½®æ–‡ä»¶ä¼šè‡ªåŠ¨åˆ›å»º
```

### å¼€å‘æŒ‡å—

#### é¡¹ç›®ç»“æ„

```
.
â”œâ”€â”€ cmd/
â”‚   â””â”€â”€ server/          # ç¨‹åºå…¥å£
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ api/            # HTTP API å¤„ç†
â”‚   â”œâ”€â”€ config/         # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ model/          # æ•°æ®æ¨¡å‹
â”‚   â””â”€â”€ service/        # ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€ web/                # å‰ç«¯ä»£ç 
â”‚   â”œâ”€â”€ src/
â”‚   â””â”€â”€ package.json
â””â”€â”€ config.example.yaml # ç¤ºä¾‹é…ç½®æ–‡ä»¶
```

#### å‰ç«¯å¼€å‘

1. å¼€å‘ç¯å¢ƒå¯åŠ¨

```bash
cd web
npm install
npm run dev
```

2. æ„å»º

```bash
npm run build
```

ä¸»è¦æŠ€æœ¯æ ˆï¼š

- React
- TypeScript
- Ant Design
- Vite

#### åç«¯å¼€å‘

1. å¼€å‘ç¯å¢ƒå¯åŠ¨

```bash
go run ./cmd/server  # é…ç½®æ–‡ä»¶ä¼šè‡ªåŠ¨åˆ›å»º
```

2. æ„å»º

```bash
go build -o greenwake-bridge ./cmd/server
```

ä¸»è¦åŠŸèƒ½æ¨¡å—ï¼š

- `api`: HTTP API è·¯ç”±å’Œå¤„ç†
- `service/pc.go`: ä¸»æœºç®¡ç†å’Œå”¤é†’
- `service/forward.go`: ç«¯å£è½¬å‘
- `config`: é…ç½®æ–‡ä»¶å¤„ç†

ä¸»è¦æŠ€æœ¯æ ˆï¼š

- Go
- Gin
- Wake-on-LAN
- TCP ç«¯å£è½¬å‘

#### API æ¥å£

- `GET /api/pc/hosts`: è·å–ä¸»æœºåˆ—è¡¨
- `GET /api/pc/:hostName/status`: è·å–ä¸»æœºçŠ¶æ€
- `GET /api/pc/:hostName/client_info`: è·å–å®¢æˆ·ç«¯ä¿¡æ¯
- `GET /api/pc/:hostName/forward_channels`: è·å–è½¬å‘é€šé“ä¿¡æ¯

#### Dockeræ„å»º

å¤šå¹³å°é•œåƒæ„å»º

```shell
# åˆ›å»ºæ„å»ºç¯å¢ƒ
docker buildx create --name mybuilder --driver docker-container --bootstrap
# ä½¿ç”¨æ–°åˆ›å»ºçš„æ„å»ºç¯å¢ƒ
docker buildx use mybuilder
# æ„å»ºå¹¶æ¨é€åˆ°ä»“åº“
docker buildx build --platform linux/amd64,linux/arm64 -t xuping/greenwake-bridge:latest --push .
```

#### å¼€å‘æ³¨æ„äº‹é¡¹

1. å‰ç«¯å¼€å‘æ—¶å¯ä»¥ä½¿ç”¨ mock æ•°æ®è¿›è¡Œæµ‹è¯•
2. ä¿®æ”¹é…ç½®åéœ€è¦é‡å¯æœåŠ¡
3. å¼€å‘æ—¶å»ºè®®ä½¿ç”¨ debug æ—¥å¿—çº§åˆ«
4. ä¸»æœºå”¤é†’å’Œç«¯å£è½¬å‘åŠŸèƒ½éœ€è¦åœ¨åŒä¸€ç½‘æ®µæµ‹è¯•
5. é…ç½®æ–‡ä»¶ä¼šè‡ªåŠ¨åˆ›å»ºï¼Œé»˜è®¤ä½äºç”¨æˆ·é…ç½®ç›®å½•ä¸‹

## Greenwake Guard - ç³»ç»Ÿä¼‘çœ æ§åˆ¶å·¥å…·

ä¸€ä¸ªè·¨å¹³å°çš„ç³»ç»Ÿä¼‘çœ æ§åˆ¶å·¥å…·ï¼Œæ”¯æŒå¤šç§å”¤é†’ç­–ç•¥ï¼Œå¯ä»¥é˜²æ­¢ç³»ç»Ÿåœ¨ç‰¹å®šæƒ…å†µä¸‹è¿›å…¥ä¼‘çœ çŠ¶æ€ã€‚é€‚ç”¨äºéœ€è¦ä¿æŒç³»ç»ŸæŒç»­è¿è¡Œæˆ–åœ¨ç‰¹å®šæ—¶é—´æ®µå†…ä¿æŒå”¤é†’çš„åœºæ™¯ã€‚

### åŠŸèƒ½ç‰¹ç‚¹

- ğŸŒ è·¨å¹³å°æ”¯æŒï¼šæ”¯æŒ macOSã€Windows å’Œ Linux
- ğŸ”‹ å¤šç§å”¤é†’ç­–ç•¥ï¼š
  - æ°¸ä¹…å”¤é†’ï¼šæŒç»­é˜»æ­¢ç³»ç»Ÿä¼‘çœ 
  - å®šæ—¶å”¤é†’ï¼šåœ¨æŒ‡å®šæ—¶é—´æ®µå†…ä¿æŒç³»ç»Ÿå”¤é†’
  - å¤–éƒ¨äº‹ä»¶å”¤é†’ï¼šå“åº”å¤–éƒ¨äº‹ä»¶ï¼ˆå¦‚ç½‘ç»œåŒ…ï¼‰æ—¶ä¿æŒç³»ç»Ÿå”¤é†’
- ğŸ”„ çµæ´»çš„ä¼‘çœ æ¨¡å¼ï¼š
  - ç³»ç»Ÿæ§åˆ¶ï¼šç”±ç³»ç»Ÿè‡ªåŠ¨ç®¡ç†ä¼‘çœ 
  - ç¨‹åºæ§åˆ¶ï¼šç”±ç¨‹åºç®¡ç†ä¼‘çœ æ—¶æœº
- ğŸŒ å›½é™…åŒ–æ”¯æŒï¼šæ”¯æŒä¸­æ–‡å’Œè‹±æ–‡ç•Œé¢
- ğŸ–¥ï¸ ç³»ç»Ÿæ‰˜ç›˜ï¼šå‹å¥½çš„ç³»ç»Ÿæ‰˜ç›˜ç•Œé¢å’Œå¿«æ·æ“ä½œ
- âš¡ è½»é‡çº§ï¼šèµ„æºå ç”¨å°‘ï¼Œè¿è¡Œç¨³å®š

### å®‰è£…æ–¹å¼

#### macOS

1. ä¸‹è½½æœ€æ–°çš„ DMG æ–‡ä»¶
2. æ‰“å¼€ DMG æ–‡ä»¶å¹¶å°† Greenwake Guard.app æ‹–åˆ° Applications æ–‡ä»¶å¤¹
3. ä» Applications æ–‡ä»¶å¤¹å¯åŠ¨ Greenwake Guard

#### Windows

1. ä¸‹è½½æœ€æ–°çš„å®‰è£…åŒ…ï¼ˆæ”¯æŒ x64 å’Œ ARM64ï¼‰
2. è¿è¡Œå®‰è£…ç¨‹åº
3. æ ¹æ®å‘å¯¼å®Œæˆå®‰è£…
4. ä»å¼€å§‹èœå•æˆ–æ¡Œé¢å¿«æ·æ–¹å¼å¯åŠ¨

#### Linux

æä¾›ä¸‰ç§å®‰è£…æ–¹å¼ï¼š

1. DEB åŒ…å®‰è£…ï¼ˆUbuntu/Debianï¼‰ï¼š

```bash
sudo dpkg -i greenwake-guard_*_amd64.deb
```

2. RPM åŒ…å®‰è£…ï¼ˆFedora/RHELï¼‰ï¼š

```bash
sudo rpm -i greenwake-guard-*.rpm
```

3. é€šç”¨å®‰è£…è„šæœ¬ï¼š

```bash
chmod +x GreenwakeGuard_*.sh
./GreenwakeGuard_*.sh
```

### é…ç½®æ–‡ä»¶è¯´æ˜

```yaml
log:
  level: "debug"  # æ—¥å¿—çº§åˆ«ï¼šdebug, info, warn, errorï¼ˆé»˜è®¤ï¼šdebugï¼‰

strategy: "external_wake"  # å”¤é†’ç­–ç•¥ï¼šexternal_wake, permanent, timedï¼ˆé»˜è®¤ï¼šexternal_wakeï¼‰
sleep_mode: "program"     # ä¼‘çœ æ¨¡å¼ï¼šsystem, programï¼ˆé»˜è®¤ï¼šprogramï¼‰
timed_duration: "30m"     # å®šæ—¶å”¤é†’æŒç»­æ—¶é—´ï¼ˆé»˜è®¤ï¼š30mï¼‰
program_sleep_delay: 60   # ç¨‹åºæ§åˆ¶ç¡çœ æ¨¡å¼ä¸‹ç­‰å¾…ç¡çœ æ—¶é—´ï¼ˆé»˜è®¤ï¼š60ç§’ï¼‰

external_wake:
  wol_port: 9            # WOL ç›‘å¬ç«¯å£ï¼ˆé»˜è®¤ï¼š9ï¼‰
  timeout_secs: 300      # å¤–éƒ¨å”¤é†’è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤ï¼š300ç§’ï¼‰
  valid_events: "wol,device"  # æœ‰æ•ˆçš„å”¤é†’äº‹ä»¶ç±»å‹ï¼ˆé»˜è®¤ï¼šwol,deviceï¼‰
```

å¦‚æœæ²¡æœ‰æä¾›é…ç½®æ–‡ä»¶ï¼Œç¨‹åºä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªé»˜è®¤é…ç½®ã€‚é»˜è®¤é…ç½®åŒ…æ‹¬ï¼š

- æ—¥å¿—çº§åˆ«ï¼šdebug
- å”¤é†’ç­–ç•¥ï¼šexternal_wakeï¼ˆå¤–éƒ¨äº‹ä»¶å”¤é†’ï¼‰
- ä¼‘çœ æ¨¡å¼ï¼šprogramï¼ˆç¨‹åºæ§åˆ¶ï¼‰
- å®šæ—¶å”¤é†’æŒç»­æ—¶é—´ï¼š30åˆ†é’Ÿ
- ç¨‹åºæ§åˆ¶ç¡çœ æ¨¡å¼ä¸‹ç­‰å¾…ç¡çœ æ—¶é—´ï¼š60ç§’
- WOL ç›‘å¬ç«¯å£ï¼š9
- å¤–éƒ¨å”¤é†’è¶…æ—¶æ—¶é—´ï¼š300ç§’
- æœ‰æ•ˆçš„å”¤é†’äº‹ä»¶ç±»å‹ï¼šwol,device
